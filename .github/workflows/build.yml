name: Build

on: push

jobs:
#  linux:
#    runs-on: ${{ matrix.os }}
#
#    strategy:
#      matrix:
#        include:
#        - os: ubuntu-18.04
#          cuda: "10.2"
#        # - os: ubuntu-16.04
#        #   cuda: "9.2"
#
#    steps:
#    - uses: actions/checkout@v2
#
#    - name: Install CUDA
#      env:
#        CUDA: ${{ matrix.cuda }}
#      run: .github/tools/linux-install-cuda.sh
#
#    - name: Install Vulkan
#      run: .github/tools/linux-install-vulkan.sh
#
#    - run: cmake .
#
#    - run: make
#
#    - name: rename library
#      run: |
#        REF="${{ github.ref }}"
#        if [[ "$REF" == refs/tags/v* ]]; then
#          mv src/libgpu-setup.so src/libgpu-setup-${REF#refs/tags/v}.so
#        fi
#
#    - uses: actions/upload-artifact@v2
#      with:
#        name: linux
#        path: libgpu-setup*.so
#
#    - uses: actions/upload-artifact@v2
#      with:
#        name: linux
#        path: include/api.h
#
#  windows:
#    runs-on: ${{ matrix.os }}
#
#    strategy:
#      matrix:
#        include:
#        - os: windows-2016
#          cuda: "10.2.89"
#          cuda_hash: b538271c4d9ffce1a8520bf992d9bd23854f0f29cee67f48c6139e4cf301e253
#          vulkan: "1.1.126.0"
#          vs_path: c:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise
#
#    steps:
#    - uses: actions/checkout@v2
#
#    - name: Install CUDA
#      run: choco install cuda --version=${{ matrix.cuda }} --checksum ${{ matrix.cuda_hash }}
#
#    - name: Install Vulkan
#      run: choco install vulkan-sdk --version=${{ matrix.vulkan }}
#
#    - name: Build
#      env:
#        VULKAN_SDK: c:/VulkanSDK/${{ matrix.vulkan }}
#      run: |
#        call "${{ matrix.vs_path }}\VC\Auxiliary\Build\vcvars64.bat"
#        mkdir build
#        cd build
#        "${{ matrix.vs_path }}\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin\cmake" -G "Ninja" -DCMAKE_IGNORE_PATH="C:/Strawberry/c/bin;C:/ProgramData/chocolatey/bin" -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v10.2" -DCMAKE_MAKE_PROGRAM="${{ matrix.vs_path }}\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja\ninja.exe" ..
#        cmake --build .
#      shell: cmd
#
#    - name: Upload DLL
#      uses: actions/upload-artifact@v2
#      with:
#        name: windows
#        path: build/src/gpu-setup*.dll
#
#    - name: Upload lib
#      uses: actions/upload-artifact@v2
#      with:
#        name: windows
#        path: build/src/gpu-setup*.lib
#
#    - name: Upload api.h
#      uses: actions/upload-artifact@v2
#      with:
#        name: windows
#        path: include/api.h

  macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install Vulkan
      run: .github/tools/macos-install-vulkan.sh

    - run: cmake -DSPACEMESHCL=OFF -DSPACEMESHCUDA=OFF .

    - run: make

    - name: rename library
      run: |
        REF="${{ github.ref }}"
        if [[ "$REF" == refs/tags/v* ]]; then
          mv src/libgpu-setup.dylib src/libgpu-setup-${REF#refs/tags/v}.dylib
        fi

    - name: Upload library
      uses: actions/upload-artifact@v2
      with:
        name: macos
        path: src/libgpu-setup*.dylib

    - name: Upload api.h
      uses: actions/upload-artifact@v2
      with:
        name: macos
        path: include/api.h

  release:
    runs-on: ubuntu-latest
#    needs: [linux, windows, macos]
    needs: [macos]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - id: release
        uses: release-drafter/release-drafter@v5

      - uses: actions/download-artifact@v2

      - run: |
          VER="${{ github.ref }}"
          echo "::set-env name=VERSION::${VER#refs/tags/v}"

#      - name: Archive Linux Library
#        run: zip --junk-paths linux-${{ env.VERSION }} linux/*
#
#      - name: Archive Windows Library
#        run: zip --junk-paths windows-${{ env.VERSION }} windows/*

      - name: Archive MacOS Library
        run: zip --junk-paths macos-${{ env.VERSION }} macos/*

#      - name: Upload Linux Library
#        uses: actions/upload-release-asset@v1
#        with:
#          upload_url: ${{ steps.release.outputs.upload_url }}
#          asset_path: ./linux-${{ env.VERSION }}.zip
#          asset_name: linux-${{ env.VERSION }}.zip
#          asset_content_type: application/zip
#
#      - name: Upload Windows Library
#        uses: actions/upload-release-asset@v1
#        with:
#          upload_url: ${{ steps.release.outputs.upload_url }}
#          asset_path: ./windows-${{ env.VERSION }}.zip
#          asset_name: windows-${{ env.VERSION }}.zip
#          asset_content_type: application/zip

      - name: Upload MacOS Library
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./macos-${{ env.VERSION }}.zip
          asset_name: macos-${{ env.VERSION }}.zip
          asset_content_type: application/zip
